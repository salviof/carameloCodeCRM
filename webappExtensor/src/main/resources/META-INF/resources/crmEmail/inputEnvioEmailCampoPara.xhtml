<ui:composition
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:cc="http://java.sun.com/jsf/composite"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:SBAcaoNav="http://xmlns.jcp.org/jsf/composite/SBComp/composite/acoesENavegacao"
    xmlns:crmEmail="http://xmlns.jcp.org/jsf/composite/crmEmail"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:p="http://primefaces.org/ui"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:crm="http://xmlns.jcp.org/jsf/composite/crm">


    <!-- INTERFACE -->
    <cc:interface>
        <cc:attribute name="email"
                      type="br.org.carameloCode.erp.modulo.crm.entidadesJPA.mail.envioEmail.envioEmail.EnvioEmail" required="true"/>
    </cc:interface>
    <!-- IMPLEMENTATION -->
    <cc:implementation>
        <h:panelGroup id="compEmailPara" layout="block" >
            <p:fragment >
                <p:commandButton
                    id="commandModalNovoContato" widgetVar="commandModalNovoContato"
                    action="#{servicoEmail.abrirModalNovoContato(cc.attrs.email)}"
                    update="@form" styleClass="invisivel"
                    style="position: absolute;"
                    onstart="bloquearArea('#{pgUtil.gerarCaminhoCompletoID('campo-email-para')}')"
                    >
                    <f:setPropertyActionListener
                        target="#{paginaAtual.infoPagina.comoFormularioWeb.campoInstSelecionado}"
                        value="#{cc.attrs.email.getCampoInstanciadoByNomeOuAnotacao('contatos')}"
                        />
                    <p:ajax event="dialogReturn"
                            listener="#{paginaAtual.comoPaginaComModalEmail.onModalNovoContatoEmailClose}"
                            onstart="bloquearArea('#{pgUtil.gerarCaminhoCompletoID('campo-email-para')}')"
                            onsuccess="desbloquearArea('#{pgUtil.gerarCaminhoCompletoID('campo-email-para')}')"
                            update="#{pgUtil.gerarCaminhoCompletoID('campo-email-para')} #{pgUtil.gerarCaminhoCompletoID('campo-anexos')}"/>
                </p:commandButton>
            </p:fragment>

            <p:autoComplete
                id="campo-email-para" multiple="true" value="#{cc.attrs.email.contatos}"
                completeMethod="#{servicoEmail.contatosDoUsuarioByFiltroTermo}"
                autoSelection="true"
                style=" "
                minQueryLength="4"
                queryDelay="2000"
                placeholder="DestinatÃ¡rios: #{cc.attrs.email.prospecto != null ?'(pesquisando contatos em:':'(Procure ou cadstre os contato digitando por email, ou nome)'}  #{cc.attrs.email.prospecto != null ?cc.attrs.email.prospecto.nome.concat(')'):''} "
                styleClass="autoCompleteResponsivo"
                var="contato" itemLabel="#{contato.email}" itemValue="#{contato}"
                converter="conversorGenerico"
                tabindex="1"
                effect="fade"

                forceSelection="true">
                <p:ajax event="query" global="false"
                        onstart="bloquearArea('#{pgUtil.gerarCaminhoCompletoID('campo-email-para')}')"
                        oncomplete="desbloquearArea('#{pgUtil.gerarCaminhoCompletoID('campo-email-para')}')"
                        />
                <f:validator  validatorId="org.super_bits.view.validadores.listaBeanSimples"/>
                <f:passThroughAttribute name="caminhoCampo" value="#{cc.attrs.email.getCampoInstanciadoByNomeOuAnotacao('contatos').nomeCompostoIdentificador}" />
                <f:passThroughAttribute name="dominio" value="#{cc.attrs.email.getCampoInstanciadoByNomeOuAnotacao('contatos').nomeClasseOrigemAtributo}" />
                <f:passThroughAttribute name="campoInstanciado" value="#{cc.attrs.email.getCampoInstanciadoByNomeOuAnotacao('contatos')}" />
                <p:ajax event="itemSelect"   listener="#{servicoEmail.adicionarParaAoEmail}"

                        oncomplete="desbloquearArea('#{pgUtil.gerarCaminhoCompletoID('campo-email-para')}')"
                        onstart="bloquearArea('#{pgUtil.gerarCaminhoCompletoID('campo-email-para')}')"
                        update="#{pgUtil.gerarCaminhoCompletoID('resumoDestino')} #{pgUtil.gerarCaminhoCompletoID('campo-anexos')}"
                        >

                    <f:setPropertyActionListener
                        target="#{paginaAtual.infoPagina.comoFormularioWeb.campoInstSelecionado}"
                        value="#{cc.attrs.email.getCampoInstanciadoByNomeOuAnotacao('contatos')}"
                        />

                </p:ajax>
                <p:ajax event="itemUnselect"   rendered="#{contato.id==0}" listener="#{servicoEmail.removerParaAoEmail}"
                        onstart="bloquearArea('#{pgUtil.gerarCaminhoCompletoID('campo-email-para')}')"
                        oncomplete="desbloquearArea('#{pgUtil.gerarCaminhoCompletoID('campo-email-para')}')"

                        >
                    <f:setPropertyActionListener
                        target="#{paginaAtual.infoPagina.comoFormularioWeb.campoInstSelecionado}"
                        value="#{cc.attrs.email.getCampoInstanciadoByNomeOuAnotacao('contatos')}"
                        />
                </p:ajax>
                <p:column styleClass="FontAdamantiumBold Fs16" style="width: 20px;">
                    <p:fragment>
                        <p:commandButton
                            icon="fa fa-user-plus"
                            rendered="#{contato.id==0}"
                            onclick="$(PrimeFaces.escapeClientId(PF('commandModalNovoContato').id)).click();"
                            process="@this"
                            >
                        </p:commandButton>
                    </p:fragment>
                    <h:panelGroup layout="block" rendered="#{contato.id>0}" >
                        <h:panelGroup rendered="#{contato.umContatoDeColaborador}"  styleClass="fa fa-handshake-o" />
                        <h:panelGroup rendered="#{contato.umContatoDeLead}"  styleClass="fa fa-building-o" />

                    </h:panelGroup>

                </p:column>
                <p:column style="width:10%;" styleClass="" >
                    <h:panelGroup rendered="#{contato.id==0}" layout="block" styleClass="OrganizadorCOntainer">
                        <i class="fa fa-user-plus" style="margin-left:40px;" />
                    </h:panelGroup>
                    <h:panelGroup rendered="#{contato.id!=0 and contato.umContatoDeLead}"  layout="block"  >
                        <img src="#{contato.prospecto.imgPequena}" style="min-width: 40px;max-width: 40px"  alt="#{contato.email}" styleClass="ui-theme" rendered="#{contato.id!=0}"/>
                    </h:panelGroup>
                    <h:panelGroup rendered="#{contato.umContatoDeColaborador}"  layout="block"  >
                        <crm:avatarEmailDeContato usuario="#{contato.comoContatoColaborador.usuario}" somenteLeitura="true" />
                    </h:panelGroup>
                </p:column>
                <p:column styleClass="FontAdamantiumBold Fs16">
                    <h:outputText styleClass="" style="" value="#{contato.nome}" rendered="#{contato.id!=0}" />
                    <h:outputText value="* Novo nome: #{contato.nome}" rendered="#{contato.id==0}" />
                </p:column>
                <p:column width="200px" styleClass="FontAdamantiumBold Fs16">
                    <h:outputText styleClass="FontAdamantiumBold"  value="#{contato.email}" rendered="#{contato.id!=0}"   />
                    <h:outputText value="* Novo e-mail: #{contato.email}" rendered="#{contato.id==0}" />
                </p:column>
                <h:outputText value="#{contato.nome}" rendered="#{contato.id!=0}"  />

                <p:focus  for="@parent"/>
            </p:autoComplete>
            <script >
                $('document').ready(function () {
                    //    PrimeFaces.focus("#{pgUtil.gerarCaminhoCompletoID('campo-email-para')}");

                });

            </script>
        </h:panelGroup>

    </cc:implementation>
</ui:composition>